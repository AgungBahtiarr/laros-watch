---
import Layout from "../../layouts/Layout.astro";

export const prerender = false; // Set page to be server-rendered

// Define types as before
interface Interface {
    id: number;
    nodeId: number;
    ifIndex: number;
    ifName: string;
    ifDescr: string;
    ifType: string;
    ifPhysAddress: string;
    ifOperStatus: number;
    opticalTx: string | null;
    opticalRx: string | null;
    sfpInfo: any | null;
    lastChange: string;
    createdAt: string;
    updatedAt: string;
}

interface Node {
    id: number;
    deviceId: number;
    name: string;
    popLocation: string;
    lat: string;
    lng: string;
    ipMgmt: string;
    snmpCommunity: string;
    status: boolean;
    os: string;
    cpuUsage: number;
    ramUsage: number;
    createdAt: string;
    updatedAt: string;
    interfaces: Interface[];
}

const { id } = Astro.params;
let node: Node | null = null;
try {
    const response = await fetch(
        `${import.meta.env.PUBLIC_API_BASE_URL}/api/nodes`,
    );
    if (response.ok) {
        const nodes: Node[] = await response.json();
        node = nodes.find((n) => n.id.toString() === id) || null;
    }
} catch (error) {
    console.error("Failed to fetch node details:", error);
}
---

<Layout title={node ? `Node Details: ${node.name}` : "Node Not Found"}>
    <main class="container mx-auto p-4 md:p-8">
        {
            node ? (
                <>
                    <header class="mb-8">
                        <a href="/" class="btn btn-ghost btn-sm mb-4">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-4 w-4"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    d="M10 19l-7-7m0 0l7-7m-7 7h18"
                                />
                            </svg>
                            Back to Nodes
                        </a>
                        <div class="flex items-center gap-4">
                            <h1 class="text-3xl font-bold text-base-content">
                                {node.name}
                            </h1>
                            <div
                                id={`node-status-badge-${node.id}`}
                                class={`badge ${node.status ? "badge-success" : "badge-error"} badge-lg gap-2`}
                            >
                                <span
                                    class={`animate-pulse inline-block h-2 w-2 rounded-full ${node.status ? "bg-success-content" : "bg-error-content"}`}
                                />
                                {node.status ? "Online" : "Offline"}
                            </div>
                        </div>
                        <p class="text-base-content/60">{node.popLocation}</p>
                    </header>

                    <div class="card bg-base-100 border border-base-300 mb-8">
                        <div class="card-body p-6">
                            <h2 class="card-title text-lg font-semibold">
                                Node Information
                            </h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-4 mt-2 text-sm">
                                <div class="flex flex-col">
                                    <span class="text-xs text-base-content/60">
                                        Device ID
                                    </span>
                                    <span class="font-medium">
                                        {node.deviceId}
                                    </span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-xs text-base-content/60">
                                        IP Management
                                    </span>
                                    <span class="font-medium">
                                        {node.ipMgmt}
                                    </span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-xs text-base-content/60">
                                        Operating System
                                    </span>
                                    <span class="font-medium">{node.os}</span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-xs text-base-content/60">
                                        CPU Usage
                                    </span>
                                    <span
                                        id={`node-cpu-text-${node.id}`}
                                        class="font-medium"
                                    >
                                        {node.cpuUsage}%
                                    </span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-xs text-base-content/60">
                                        RAM Usage
                                    </span>
                                    <span
                                        id={`node-ram-text-${node.id}`}
                                        class="font-medium"
                                    >
                                        {node.ramUsage}%
                                    </span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-xs text-base-content/60">
                                        Coordinates
                                    </span>
                                    <span class="font-medium">
                                        {node.lat}, {node.lng}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h2 class="text-xl font-bold text-base-content mb-4">
                        Interfaces
                    </h2>
                    <div class="overflow-x-auto border border-base-300 rounded-lg">
                        <table class="table w-full">
                            <thead class="bg-base-200/30">
                                <tr>
                                    <th class="w-1/4">Name</th>
                                    <th>Description</th>
                                    <th>Type</th>
                                    <th>MAC Address</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {node.interfaces.map((iface) => (
                                    <tr
                                        id={`interface-row-${iface.id}`}
                                        class="hover:bg-base-200/20"
                                    >
                                        <td class="font-medium">
                                            {iface.ifName}
                                        </td>
                                        <td>{iface.ifDescr}</td>
                                        <td>{iface.ifType}</td>
                                        <td>{iface.ifPhysAddress}</td>
                                        <td>
                                            <span
                                                id={`interface-status-badge-${iface.id}`}
                                                class={`badge badge-sm ${iface.ifOperStatus === 1 ? "badge-success" : "badge-error"} gap-1.5`}
                                            >
                                                <span
                                                    class={`animate-pulse inline-block h-1.5 w-1.5 rounded-full ${iface.ifOperStatus === 1 ? "bg-success-content" : "bg-error-content"}`}
                                                />
                                                {iface.ifOperStatus === 1
                                                    ? "Up"
                                                    : "Down"}
                                            </span>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </>
            ) : (
                <div class="text-center py-16">
                    <h1 class="text-2xl font-bold">Node not found</h1>
                    <a href="/nodes" class="btn btn-primary mt-4">
                        Back to Nodes List
                    </a>
                </div>
            )
        }
    </main>
    <script
        define:vars={{
            nodeId: node?.id,
            apiUrl: import.meta.env.PUBLIC_API_BASE_URL,
        }}
    >
        let eventSource;

        function initSSE() {
            if (!nodeId) return;

            if (
                eventSource &&
                (eventSource.readyState === 0 || eventSource.readyState === 1)
            ) {
                return;
            }
            if (eventSource) {
                eventSource.close();
            }

            console.log("Initializing SSE on detail page...");
            try {
                eventSource = new EventSource(
                    `${apiUrl}/api/nodes/status/events`,
                );

                eventSource.onopen = () => {
                    console.log("SSE Connection Opened on detail page!");
                };

                const updateNodeUI = (nodeData) => {
                    const statusBadge = document.getElementById(
                        `node-status-badge-${nodeData.id}`,
                    );
                    const cpuText = document.getElementById(
                        `node-cpu-text-${nodeData.id}`,
                    );
                    const ramText = document.getElementById(
                        `node-ram-text-${nodeData.id}`,
                    );

                    if (statusBadge) {
                        statusBadge.textContent = nodeData.status
                            ? "Online"
                            : "Offline";
                        statusBadge.className = `badge ${nodeData.status ? "badge-success" : "badge-error"} badge-lg badge-outline`;
                    }
                    if (cpuText) cpuText.textContent = `${nodeData.cpuUsage}%`;
                    if (ramText) ramText.textContent = `${nodeData.ramUsage}%`;
                };

                const updateInterfaceUI = (ifaceData) => {
                    const statusBadge = document.getElementById(
                        `interface-status-badge-${ifaceData.id}`,
                    );
                    if (statusBadge) {
                        statusBadge.textContent =
                            ifaceData.ifOperStatus === 1 ? "Up" : "Down";
                        statusBadge.className = `badge badge-sm ${ifaceData.ifOperStatus === 1 ? "badge-success" : "badge-warning"} badge-outline`;
                    }
                };

                eventSource.addEventListener("notification", (event) => {
                    try {
                        const eventData = JSON.parse(event.data);

                        if (
                            eventData.nodeChanges &&
                            Array.isArray(eventData.nodeChanges)
                        ) {
                            const relevantChange = eventData.nodeChanges.find(
                                (n) => n.id === nodeId,
                            );
                            if (relevantChange) {
                                updateNodeUI(relevantChange);
                            }
                        }

                        if (
                            eventData.interfaceChanges &&
                            Array.isArray(eventData.interfaceChanges)
                        ) {
                            eventData.interfaceChanges.forEach((iface) => {
                                if (iface.nodeId === nodeId) {
                                    updateInterfaceUI(iface);
                                }
                            });
                        }
                    } catch (error) {
                        console.error(
                            "Failed to parse SSE data or update UI:",
                            error,
                        );
                    }
                });

                eventSource.onerror = (e) =>
                    console.error("SSE error on detail page", e);
            } catch (e) {
                console.error("Error creating EventSource on detail page:", e);
            }
        }

        document.addEventListener("astro:page-load", initSSE);
        initSSE();
    </script>
</Layout>
